---
alwaysApply: true
---

# Closepay V2 - Member Base App - Comprehensive Project Rules

## ğŸ“± Project Overview

**Nama**: Closepay V2 - Member Base App  
**Deskripsi**: React Native application untuk Closepay Member Base dengan multi-tenant support, plugin system, dan custom UI components.  
**React Native**: 0.82.1  
**TypeScript**: 5.8.3  
**Node.js**: >= 20  

---

## ğŸ›ï¸ Arsitektur Layer (Hierarchy)

### Layer Overview
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           APPS (Company-Specific)       â”‚  apps/{companyInitial}/
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         PLUGINS (Domain-Specific)       â”‚  packages/plugins/{module}/
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         FEATURES (Generic)*             â”‚  packages/features/{module}/ (planned)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           CORE (Foundation)             â”‚  packages/core/{module}/
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1. **CORE** (Foundation) - `packages/core/`
Generik, reusable, tidak bergantung domain spesifik.

**Modules yang tersedia:**
| Module | Path | Deskripsi |
|--------|------|-----------|
| `auth` | `packages/core/auth/` | Authentication, JWT token management |
| `config` | `packages/core/config/` | Configuration system, plugin loader, responsive utilities |
| `account` | `packages/core/account/` | User profile, company, outlet management |
| `notification` | `packages/core/notification/` | Notification service dan components |
| `theme` | `packages/core/theme/` | Theming system (dark/light mode) |
| `i18n` | `packages/core/i18n/` | Internationalization (Indonesian & English) |
| `security` | `packages/core/security/` | FreeRASP integration, security features |
| `native` | `packages/core/native/` | Native config access (environment variables) |
| `navigation` | `packages/core/navigation/` | Navigation utilities |

**Rules:**
- âŒ Core TIDAK BOLEH depend ke Features/Plugins
- âŒ JANGAN diubah per company
- âœ… Hanya operasi generik (auth, config, account management)

### 2. **FEATURES** (Generic) - `packages/features/`
Abstraksi generik untuk fitur yang dipakai banyak segment.

**Status**: âš ï¸ Folder belum ada (planned)

**Planned Modules:**
- `catalog` - Product catalog abstraction
- `order` - Order processing abstraction
- `reporting` - Reporting abstraction

**Rules:**
- âŒ Features TIDAK BOLEH depend ke Plugins
- âŒ JANGAN diubah per company
- âœ… Abstrasi generik (Product, Order, Report)

### 3. **PLUGINS** (Domain-Specific) - `packages/plugins/`
Logic dan UI spesifik domain. Bisa di-extend dan customize per company.

**Core Plugins (bisa di-enable/disable):**
| Plugin | Path | Deskripsi |
|--------|------|-----------|
| `balance` | `packages/plugins/balance/` | Balance ledger (immutable) |
| `payment` | `packages/plugins/payment/` | Payment gateway (single entry point) |

**Domain Plugins:**
| Plugin | Path | Deskripsi |
|--------|------|-----------|
| `catalog` | `packages/plugins/catalog/` | Product catalog management |
| `order` | `packages/plugins/order/` | Order processing |
| `reporting` | `packages/plugins/reporting/` | Analytics & reports |
| `invoice` | `packages/plugins/invoice/` | Invoicing system |
| `bank-sampah` | `packages/plugins/bank-sampah/` | Waste bank |
| `kso` | `packages/plugins/kso/` | Operational cooperation |
| `card-transaction` | `packages/plugins/card-transaction/` | Card payment processing |
| `donasi` | `packages/plugins/donasi/` | Donations |
| `marketplace-fnb` | `packages/plugins/marketplace-fnb/` | F&B marketplace |
| `marketplace-produk` | `packages/plugins/marketplace-produk/` | Product marketplace |

**Rules:**
- âœ… Plugins BOLEH depend ke Core & Features
- âœ… Plugins BOLEH memanggil plugin lain
- âœ… Bisa di-extend dan customize per company

### 4. **APPS** (Company-Specific) - `apps/`
Company-specific applications dengan config, assets, dan overrides.

**Structure:**
```
apps/{companyId}/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ app.config.ts        # Main app configuration
â”‚   â”œâ”€â”€ app.config.template.ts
â”‚   â””â”€â”€ theme.color.ts       # Theme color overrides
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ android/             # Android icons (mipmap-*)
â”‚   â””â”€â”€ ios/                 # iOS icons (AppIcon.appiconset)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/          # App-specific components
â”‚   â””â”€â”€ screens/             # App-specific screens
â”œâ”€â”€ tools/                   # App tools (CMS, etc)
â”œâ”€â”€ index.tsx                # App entry point
â””â”€â”€ README.md
```

**Rules:**
- âœ… Company-specific config, assets, overrides
- âœ… Customization via AppConfig, bukan modify base code
- âŒ JANGAN modify core/features/plugins untuk customization per company

---

## ğŸ“¦ Dependency Rules (STRICT)

### âœ… ALLOWED - Dependency Flow
```
Apps â†’ Plugins â†’ Features â†’ Core
```

### âŒ FORBIDDEN - Reverse Dependency
- Core â†’ Features âŒ
- Core â†’ Plugins âŒ
- Core â†’ Apps âŒ
- Features â†’ Plugins âŒ
- Features â†’ Apps âŒ
- Plugins â†’ Apps âŒ

### Contoh Implementasi

#### âœ… BENAR: Plugin memanggil Core
```typescript
// packages/plugins/payment/services/paymentService.ts
import { tokenService } from '../../../core/auth';
import { configService } from '../../../core/config';
const token = await tokenService.getToken();
```

#### âœ… BENAR: Plugin memanggil Plugin lain
```typescript
// packages/plugins/payment/services/paymentService.ts
import { mutationService } from '../../balance/services/mutationService';
import { TransactionType } from '../../balance/models/TransactionType';
```

#### âŒ SALAH: Core tahu tentang domain spesifik
```typescript
// JANGAN di core - ini domain specific!
core.topUpWithWaste(kg) // âŒ Harusnya di plugin bank-sampah
```

---

## ğŸ“ Struktur Folder

### Core Module Structure
```
packages/core/{module}/
â”œâ”€â”€ models/          # Data models
â”œâ”€â”€ services/        # Business logic
â”œâ”€â”€ hooks/           # React hooks
â”œâ”€â”€ components/      # UI components (jika ada)
â”œâ”€â”€ types/           # TypeScript types
â”œâ”€â”€ context/         # React context (jika ada)
â”œâ”€â”€ stores/          # Zustand stores (jika ada)
â””â”€â”€ index.ts         # Export semua public API
```

### Plugin Module Structure
```
packages/plugins/{module}/
â”œâ”€â”€ components/      # UI components
â”œâ”€â”€ hooks/           # Custom hooks
â”œâ”€â”€ models/          # Data models (jika ada)
â”œâ”€â”€ services/        # Business logic (jika ada)
â”œâ”€â”€ types/           # TypeScript types (jika ada)
â”œâ”€â”€ plugin.manifest.json  # Plugin manifest
â””â”€â”€ index.ts         # Module definition
```

### App Structure
```
apps/{companyInitial}/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ app.config.ts         # AppConfig instance
â”‚   â”œâ”€â”€ app.config.template.ts
â”‚   â””â”€â”€ theme.color.ts        # Theme overrides
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ android/
â”‚   â”‚   â””â”€â”€ mipmap-*/         # ic_launcher.png, ic_launcher_round.png
â”‚   â””â”€â”€ ios/
â”‚       â””â”€â”€ AppIcon.appiconset/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ home/             # Home-specific components
â”‚   â””â”€â”€ screens/
â”œâ”€â”€ tools/
â””â”€â”€ index.tsx
```

---

## ğŸ’° Balance & Payment System Rules

### Balance Plugin (Ledger)
**Lokasi**: `packages/plugins/balance/`

**Prinsip:**
- ğŸ”’ **Immutable**: Mutasi tidak bisa diubah/dihapus
- ğŸ“Š **Single Source of Truth**: Saldo = penjumlahan semua mutasi
- ğŸ”„ **Audit Trail**: Setiap perubahan tercatat
- âŒ **No Direct Access**: Tidak ada operasi uang langsung ke balance service
- ğŸ“¦ **Core Plugin**: Bisa di-enable/disable via AppConfig

**Components:**
- `TransactionHistoryScreen`
- `TopUpIcon`, `WithdrawIcon`

**Services:**
- `balanceService`, `mutationService`

**Models:**
- `BalanceAccount`, `BalanceMutation`, `TransactionType`

### Payment Plugin (Gateway)
**Lokasi**: `packages/plugins/payment/`

**Prinsip:**
- ğŸšª **Single Entry Point**: Semua operasi uang melalui payment service
- ğŸ”„ **Auto Update Ledger**: Semua operasi update balance/ledger
- ğŸ”‘ **Idempotency**: Support idempotency key
- ğŸ”— **Dependency**: Payment plugin depends on balance plugin

**Components:**
- `TopUpScreen`, `WithdrawScreen`, `VirtualAccountScreen`

**Services:**
- `paymentService`, `topUpService`, `withdrawService`, `transferService`, `cardTransactionService`

### Transaction Flow
```
User Action â†’ Plugin â†’ plugins/payment â†’ plugins/balance â†’ Backend API
```

Jika menggunakan order:
```
User Action â†’ Plugin â†’ features/order â†’ plugins/payment â†’ plugins/balance â†’ Backend API
```

---

## ğŸ¨ Accent Color System (STRICT)

### Prinsip Dasar
- **Sistem seperti Windows Accent Color**: Ubah 1 accent color di config = semua warna interaktif otomatis berubah
- **Single Source of Truth**: `apps/{companyInitial}/config/app.config.ts` â†’ `branding.primaryColor`
- **Auto-Generated Colors**: Semua warna interaktif di-generate dari accent color

### âœ… DO - Warna yang HARUS Menggunakan Theme Colors

#### 1. Active/Selected States
```typescript
// âœ… BENAR
<TouchableOpacity
  style={{
    backgroundColor: isActive ? colors.primary : colors.surface,
    borderColor: isActive ? colors.primary : colors.border,
  }}
>
  <Text style={{ color: isActive ? colors.surface : colors.text }}>
    {label}
  </Text>
</TouchableOpacity>
```

#### 2. Primary Action Buttons
```typescript
// âœ… BENAR
<TouchableOpacity style={{ backgroundColor: colors.primary }}>
  <Text style={{ color: colors.surface }}>Simpan</Text>
</TouchableOpacity>
```

#### 3. Indicators & Highlights
- Tab indicator: `colors.primary`
- Progress bar: `colors.primary`
- Checkbox selected: `colors.primary`
- Radio selected: `colors.primary`

#### 4. Pill/Chip Buttons
```typescript
// âœ… BENAR
<TouchableOpacity
  style={{
    backgroundColor: isActive ? colors.primary : colors.surface,
  }}
>
  <Text style={{ color: isActive ? colors.surface : colors.text }}>
    {label}
  </Text>
</TouchableOpacity>
```

### âŒ DON'T - Hardcoded Colors

#### Jangan Hardcode Hex Colors
```typescript
// âŒ SALAH
backgroundColor: isActive ? '#0066CC' : colors.surface;
const selectedTextColor = '#FFFFFF';

// âœ… BENAR
backgroundColor: isActive ? colors.primary : colors.surface;
const selectedTextColor = colors.surface;
```

#### Jangan Hardcode di StyleSheet
```typescript
// âŒ SALAH
const styles = StyleSheet.create({
  button: { backgroundColor: '#0066CC' }, // JANGAN!
});

// âœ… BENAR - Set inline dengan theme colors
<TouchableOpacity style={[styles.button, { backgroundColor: colors.primary }]}>
```

#### Jangan Pre-create Icon dengan Hardcoded Colors
```typescript
// âŒ SALAH
const ICON_INSTANCES = {
  payIPL: <ArrowDown2 size={20} color="#3B82F6" variant="Bold" />,
};

// âœ… BENAR - Function yang menerima color parameter
const getMenuIcon = (iconName: string, iconColor: string) => {
  switch (iconName) {
    case 'payIPL':
      return <ArrowDown2 size={20} color={iconColor} variant="Bold" />;
  }
};
```

### Exception Rules

#### Error States
```typescript
// âœ… Error button menggunakan error color
<TouchableOpacity style={{ backgroundColor: colors.error }}>
  <Text style={{ color: colors.surface }}>Hapus</Text>
</TouchableOpacity>
```

#### Secondary Actions
```typescript
// âœ… Secondary button
<TouchableOpacity
  style={{
    backgroundColor: colors.surface,
    borderColor: colors.border,
    borderWidth: 1,
  }}
>
  <Text style={{ color: colors.primary }}>Batal</Text>
</TouchableOpacity>
```

### Testing Accent Color
Setelah implementasi, test dengan mengubah accent color:
```typescript
// apps/member-base/config/app.config.ts
branding: {
  primaryColor: '#EF4444', // Ubah ke merah
}
```

**Expected Result:**
- âœ… Semua button primary menjadi merah
- âœ… Semua indicator menjadi merah
- âœ… Semua active/selected states menjadi merah

---

## ğŸ“ TypeScript Rules

### âœ… DO
```typescript
// Define interfaces untuk semua contracts
interface UserProfile {
  id: string;
  name: string;
  email: string;
}

// Use strict typing
const user: UserProfile = await getUser();

// Export types dari index.ts
export type { UserProfile } from './types';
```

### âŒ DON'T
```typescript
// Avoid `any` type
const data: any = response; // âŒ

// Proper typing
const data: ApiResponse<UserProfile> = response; // âœ…
```

---

## ğŸ“› Naming Conventions

| Type | Convention | Example |
|------|------------|---------|
| Modules/Folders | kebab-case | `balance-management`, `bank-sampah` |
| Components | PascalCase | `ProfileScreen.tsx`, `BalanceCard.tsx` |
| Utilities/Services | camelCase | `authService.ts`, `formatCurrency.ts` |
| Types/Interfaces | PascalCase | `UserProfile`, `AppConfig` |
| Hooks | camelCase + `use` prefix | `useAuth`, `useTheme`, `useTranslation` |
| Constants | SCREAMING_SNAKE_CASE | `API_BASE_URL`, `MAX_RETRY_COUNT` |
| Test Files | *.test.ts(x) atau *.spec.ts(x) | `auth.test.ts`, `LoginScreen.spec.tsx` |

---

## ğŸ“¥ Import Rules

### Path Aliases (tsconfig.json & babel.config.js)
```typescript
// Core imports
import { useAuth } from '@core/auth';
import { useTheme } from '@core/theme';
import { useTranslation } from '@core/i18n';
import { scale, moderateScale } from '@core/config';

// Plugin imports
import { TransactionHistoryScreen } from '@plugins/balance';
import { TopUpScreen } from '@plugins/payment';

// App imports
import { HomeScreen } from '@app/screens';
```

### Relative Imports (within same package)
```typescript
// Dalam core module
import { tokenService } from '../auth/services/tokenService';

// Dalam plugin
import { mutationService } from '../../balance/services/mutationService';
```

### Import dari index.ts
```typescript
// âœ… BENAR - Import dari index
import { useAuth, authService, LoginScreen } from '@core/auth';

// âŒ SALAH - Import langsung dari file
import { useAuth } from '@core/auth/hooks/useAuth';
```

---

## âš™ï¸ Configuration System

### AppConfig Interface
```typescript
interface AppConfig {
  companyInitial: string;
  companyName: string;
  tenantId: string;
  segmentId: string;
  
  enabledFeatures: string[];
  enabledModules: string[];
  
  homeVariant: 'dashboard' | 'member';
  homeTabs: TabConfig[];
  menuConfig: MenuConfig[];
  paymentMethods: string[];
  
  branding: {
    logo?: string;
    appName: string;
    primaryColor?: string;
  };
  
  login: {
    showSignUp: boolean;
    showSocialLogin: boolean;
    socialLoginProviders: string[];
  };
  
  services: {
    api: { baseUrl: string; timeout: number };
    auth: { useMock: boolean };
    features: { pushNotification: boolean; analytics: boolean; crashReporting: boolean };
  };
  
  showQrButton?: boolean;
}
```

### Environment Variables
```
.env.staging     â†’ Development/Staging environment
.env.production  â†’ Production environment
```

**Access via:**
```typescript
import Config from '@core/native/Config';
const apiUrl = Config.API_BASE_URL;
```

### Feature Flags
Feature diaktifkan via `enabledFeatures` dan `enabledModules` di AppConfig.

---

## ğŸ—ï¸ Development Workflow

### Build Order
```
1. Core â†’ 2. Features â†’ 3. Plugins â†’ 4. Apps
```

### Available Scripts

#### Development
```bash
npm start              # Start Metro bundler
npm run android        # Run on Android
npm run ios            # Run on iOS
```

#### Building
```bash
npm run build:apk:debug     # Debug APK
npm run build:apk           # Release APK
npm run build:apk:staging   # Staging APK
npm run build:apk:prod      # Production APK
npm run build:aab           # Android App Bundle
```

#### Testing
```bash
npm test                    # Run tests
npm run test:coverage       # With coverage
npm run test:e2e:android    # E2E Android
npm run test:e2e:ios        # E2E iOS
```

#### Utilities
```bash
npm run copy:assets         # Copy company assets (logo, icons)
npm run lint                # Run ESLint
```

---

## ğŸ“± Company-Specific Logo System

### Struktur Assets
```
apps/{companyInitial}/assets/
â”œâ”€â”€ android/
â”‚   â”œâ”€â”€ mipmap-mdpi/      # 48x48
â”‚   â”œâ”€â”€ mipmap-hdpi/      # 72x72
â”‚   â”œâ”€â”€ mipmap-xhdpi/     # 96x96
â”‚   â”œâ”€â”€ mipmap-xxhdpi/    # 144x144
â”‚   â””â”€â”€ mipmap-xxxhdpi/   # 192x192
â””â”€â”€ ios/
    â””â”€â”€ AppIcon.appiconset/
        â”œâ”€â”€ Contents.json
        â”œâ”€â”€ icon-20@2x.png   # 40x40
        â”œâ”€â”€ icon-20@3x.png   # 60x60
        â”œâ”€â”€ icon-29@2x.png   # 58x58
        â”œâ”€â”€ icon-29@3x.png   # 87x87
        â”œâ”€â”€ icon-40@2x.png   # 80x80
        â”œâ”€â”€ icon-40@3x.png   # 120x120
        â”œâ”€â”€ icon-60@2x.png   # 120x120
        â”œâ”€â”€ icon-60@3x.png   # 180x180
        â””â”€â”€ icon-1024.png    # 1024x1024
```

### Auto-Detection
Script `scripts/copy-company-assets.js` otomatis detect company dari import di `App.tsx`:
```typescript
// App.tsx
import MemberbaseApp from './apps/member-base';
// â†’ Company: "member-base"
```

### Switching Company
1. Update import di `App.tsx`
2. Run `npm run copy:assets` atau langsung `npm run build:apk`
3. Logo otomatis terpakai

---

## ğŸ”’ Security

### FreeRASP Integration
```typescript
// packages/core/security/SecurityProvider.tsx
import { SecurityProvider } from '@core/security';

// Wrap app dengan SecurityProvider
<SecurityProvider>
  <App />
</SecurityProvider>
```

### Security Features
- Root/Jailbreak detection
- Debugger detection
- Tamper detection
- Emulator detection

---

## ğŸŒ Internationalization (i18n)

### Usage
```typescript
import { useTranslation } from '@core/i18n';

const { t, changeLanguage, currentLanguage } = useTranslation();
const text = t('home.title');
```

### Adding Translations
```typescript
// packages/core/i18n/locales/id.ts
export default {
  home: {
    title: 'Beranda',
    welcome: 'Selamat Datang',
  },
};

// packages/core/i18n/locales/en.ts
export default {
  home: {
    title: 'Home',
    welcome: 'Welcome',
  },
};
```

---

## ğŸ¨ Theme System

### Usage
```typescript
import { useTheme } from '@core/theme';

const { colors, isDarkMode, toggleTheme } = useTheme();
```

### Theme Colors
```typescript
interface ThemeColors {
  primary: string;        // Accent color
  primaryLight: string;   // Lighter shade of primary
  surface: string;        // Background color
  background: string;     // App background
  text: string;           // Primary text
  textSecondary: string;  // Secondary text
  border: string;         // Border color
  error: string;          // Error color
  errorLight: string;     // Light error background
  success: string;        // Success color
  successLight: string;   // Light success background
  warning: string;        // Warning color
  warningLight: string;   // Light warning background
  info: string;           // Info color
  infoLight: string;      // Light info background
}
```

---

## ğŸ“ Responsive Design

### Utilities
```typescript
import { 
  scale, 
  moderateScale, 
  moderateVerticalScale,
  getHorizontalPadding,
  useDimensions 
} from '@core/config';

// Scale based on screen width
const size = scale(24);

// Moderate scale for fonts
const fontSize = moderateScale(16);

// Vertical scale
const height = moderateVerticalScale(100);

// Responsive padding
const padding = getHorizontalPadding();

// Reactive dimensions
const { width, height, isTablet } = useDimensions();
```

---

## âœ… Code Checklist

### Sebelum Commit
- [ ] Tidak ada hardcoded hex colors untuk interactive elements
- [ ] Semua active states menggunakan `colors.primary`
- [ ] Import dari index.ts, bukan file langsung
- [ ] TypeScript strict typing (no `any`)
- [ ] Dependency rules dipatuhi (Plugins â†’ Core)
- [ ] Component menggunakan responsive utilities
- [ ] Translations tersedia untuk ID & EN

### Sebelum PR
- [ ] `npm run lint` pass
- [ ] `npm test` pass
- [ ] Manual testing di Android & iOS
- [ ] Theme color testing (ubah accent color)

---

## ğŸ› Troubleshooting

### Metro Bundler Issues
```bash
npm start -- --reset-cache
```

### Android Build Issues
```bash
cd android && gradlew clean && cd ..
npm run android
```

### iOS Build Issues
```bash
cd ios && rm -rf Pods && pod install && cd ..
npm run ios
```

### Plugin tidak ter-load
1. Pastikan plugin ada di `enabledModules` di AppConfig
2. Check plugin manifest format
3. Check console untuk error messages

### Logo tidak berubah
1. Uninstall app dari device/emulator
2. Clean build (`gradlew clean` / `pod install`)
3. Rebuild

---

## ğŸ“š Additional Resources

- **README.md** - Project overview dan quick start
- **LOGO_SYSTEM.md** - Company logo system documentation
- **apps/member-base/README.md** - Member base specific documentation

---

*Last updated: 2025-12-30*
